<!--pages/data-sync/data-sync.wxml-->
<view class="page data-sync-page" style="background: {{currentTheme.background}}">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="card">
    <view class="page-title">
      <text class="title-icon">ğŸ”„</text>
      <text class="title-text">æ•°æ®åŒæ­¥</text>
    </view>
    <view class="page-subtitle">ä»å…¶ä»–ç”¨æˆ·å¤åˆ¶ä¹ æƒ¯æˆ–å¥–åŠ±åˆ°å½“å‰ç”¨æˆ·</view>
  </view>

  <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
  <view class="card">
    <view class="section-title">ğŸ“¥ åŒæ­¥åˆ°</view>
    <view class="current-user">
      <view class="user-avatar">{{currentUser.avatar}}</view>
      <view class="user-info">
        <view class="user-name">{{currentUser.name}}</view>
        <view class="user-desc">å½“å‰ç”¨æˆ·</view>
      </view>
    </view>
  </view>

  <!-- å½“å‰é€‰ä¸­çš„æºç”¨æˆ· -->
  <view class="card selected-source-card" wx:if="{{selectedUserId}}">
    <view class="section-title">ğŸ“¤ å½“å‰é€‰æ‹©çš„æºç”¨æˆ·</view>
    <view class="selected-source-user">
      <view class="user-avatar">{{selectedUser.avatar}}</view>
      <view class="user-info">
        <view class="user-name">{{selectedUser.name}}</view>
        <view class="user-stats">
          ğŸ“ {{sourceHabits.length}}ä¸ªä¹ æƒ¯ | ğŸ {{sourceRewards.length}}ä¸ªå¥–åŠ±
        </view>
      </view>
      <view class="change-source-btn" bindtap="clearSourceSelection">
        <text>é‡æ–°é€‰æ‹©</text>
      </view>
    </view>
  </view>

  <!-- é€‰æ‹©æºç”¨æˆ· -->
  <view class="card" wx:if="{{!selectedUserId}}">
    <view class="section-title">ğŸ“¤ ä»ä»¥ä¸‹ç”¨æˆ·å¤åˆ¶</view>
    <view class="users-list" wx:if="{{otherUsers.length > 0}}">
      <view
        class="user-item {{selectedUserId === item.id ? 'selected' : ''}}"
        wx:for="{{otherUsers}}"
        wx:key="id"
        bindtap="selectSourceUser"
        data-user-id="{{item.id}}"
        style="border-color: {{currentTheme.primary}}"
      >
        <view class="user-avatar">{{item.avatar}}</view>
        <view class="user-info">
          <view class="user-name">{{item.name}}</view>
          <view class="user-stats">
            ğŸ“ {{item.habitsCount || 0}}ä¹ æƒ¯ | ğŸ {{item.rewardsCount || 0}}å¥–åŠ±
          </view>
        </view>
        <view class="select-indicator" wx:if="{{selectedUserId === item.id}}">âœ“</view>
      </view>
    </view>
    <view class="empty-hint" wx:else>
      <text>æš‚æ— å…¶ä»–ç”¨æˆ·</text>
    </view>
  </view>

  <!-- é€‰æ‹©åŒæ­¥ç±»å‹ -->
  <view class="card" wx:if="{{selectedUserId}}">
    <view class="section-title">ğŸ¯ é€‰æ‹©åŒæ­¥å†…å®¹</view>
    <view class="sync-type-tabs">
      <view
        class="tab-item {{syncType === 'habits' ? 'active' : ''}}"
        bindtap="switchSyncType"
        data-type="habits"
        style="background: {{syncType === 'habits' ? currentTheme.primary : currentTheme.secondary}}; color: {{syncType === 'habits' ? '#fff' : currentTheme.primary}}"
      >
        ğŸ“ ä¹ æƒ¯ ({{sourceHabits.length}})
      </view>
      <view
        class="tab-item {{syncType === 'rewards' ? 'active' : ''}}"
        bindtap="switchSyncType"
        data-type="rewards"
        style="background: {{syncType === 'rewards' ? currentTheme.primary : currentTheme.secondary}}; color: {{syncType === 'rewards' ? '#fff' : currentTheme.primary}}"
      >
        ğŸ å¥–åŠ± ({{sourceRewards.length}})
      </view>
    </view>


  </view>

  <!-- ä¹ æƒ¯åˆ—è¡¨ -->
  <view class="card" wx:if="{{selectedUserId && syncType === 'habits'}}">
    <view class="section-header">
      <view class="section-title">é€‰æ‹©è¦å¤åˆ¶çš„ä¹ æƒ¯</view>
      <button 
        class="select-all-btn" 
        style="background: {{currentTheme.primaryLight}}; color: {{currentTheme.primary}}"
        bindtap="toggleSelectAll"
      >
        {{selectedHabits.length === sourceHabits.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
    </view>
    
    <view class="data-list" wx:if="{{sourceHabits.length > 0}}">
      <view
        class="data-item {{item.selected ? 'selected' : ''}}"
        wx:for="{{sourceHabits}}"
        wx:key="id"
        bindtap="toggleHabit"
        data-habit-id="{{item.id}}"
        style="border-color: {{currentTheme.cardBorder}}"
      >
        <view class="data-info">
          <view class="data-name">{{item.name}}</view>
          <view class="data-points" style="color: {{item.type === 'positive' ? '#28a745' : '#dc3545'}}">
            {{item.type === 'positive' ? '+' : ''}}{{item.points}}åˆ†
          </view>
        </view>
        <view
          class="select-checkbox {{item.selected ? 'checked' : ''}}"
          style="{{item.selected ? 'border-color: ' + currentTheme.primary + ' !important; background: ' + currentTheme.primary + ' !important; color: white !important;' : 'border-color: #ddd; background: #fff; color: #999;'}}"
        >
          <text wx:if="{{item.selected}}">âœ“</text>
        </view>
      </view>
    </view>
    <view class="empty-hint" wx:else>
      <text>è¯¥ç”¨æˆ·æš‚æ— ä¹ æƒ¯</text>
    </view>
  </view>

  <!-- å¥–åŠ±åˆ—è¡¨ -->
  <view class="card" wx:if="{{selectedUserId && syncType === 'rewards'}}">
    <view class="section-header">
      <view class="section-title">é€‰æ‹©è¦å¤åˆ¶çš„å¥–åŠ±</view>
      <button 
        class="select-all-btn" 
        style="background: {{currentTheme.primaryLight}}; color: {{currentTheme.primary}}"
        bindtap="toggleSelectAll"
      >
        {{selectedRewards.length === sourceRewards.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
    </view>
    
    <view class="data-list" wx:if="{{sourceRewards.length > 0}}">
      <view
        class="data-item {{item.selected ? 'selected' : ''}}"
        wx:for="{{sourceRewards}}"
        wx:key="id"
        bindtap="toggleReward"
        data-reward-id="{{item.id}}"
        style="border-color: {{currentTheme.cardBorder}}"
      >
        <view class="data-info">
          <view class="data-name">{{item.name}}</view>
          <view class="data-points" style="color: {{currentTheme.primary}}">{{item.points}}åˆ†</view>
        </view>
        <view
          class="select-checkbox {{item.selected ? 'checked' : ''}}"
          style="{{item.selected ? 'border-color: ' + currentTheme.primary + ' !important; background: ' + currentTheme.primary + ' !important; color: white !important;' : 'border-color: #ddd; background: #fff; color: #999;'}}"
        >
          <text wx:if="{{item.selected}}">âœ“</text>
        </view>
      </view>
    </view>
    <view class="empty-hint" wx:else>
      <text>è¯¥ç”¨æˆ·æš‚æ— å¥–åŠ±</text>
    </view>
  </view>

  <!-- åŒæ­¥æŒ‰é’® -->
  <view class="sync-footer" wx:if="{{selectedUserId}}">
    <button 
      class="sync-btn" 
      style="background: {{currentTheme.primary}}"
      bindtap="startSync"
    >
      ğŸ”„ å¼€å§‹åŒæ­¥ 
      <text wx:if="{{syncType === 'habits'}}">
        ({{selectedHabits.length}}ä¸ªä¹ æƒ¯)
      </text>
      <text wx:else>
        ({{selectedRewards.length}}ä¸ªå¥–åŠ±)
      </text>
    </button>
  </view>
</view>
